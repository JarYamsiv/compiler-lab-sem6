structure Translate =
struct

val red = "\u001b[31;1m"
val green = "\u001b[32;1m"
val white = "\u001b[37;1m"
val yellow = "\u001b[33;1m"
val grey = "\u001b[30;1m"
val reset = "\u001b[0m"

exception undef

structure SymTabKey = 
struct
	type ord_key = Atom.atom
	type tab_content = int
	val compare = Atom.compare
end

structure SymTable = MakeSymTable(SymTabKey)

fun addtabs n = if n <= 0 then
					("")
				else
					("   "^( addtabs (n-1)) )


(**************************************************************************************************************************************)
(**************************************************************************************************************************************)
(**************************************************translate  EXPRESSION*****************************************************************)
(**************************************************************************************************************************************)
(**************************************************************************************************************************************)


fun translateExpr (Ast.Const x )         = (" "^(Int.toString x)^" ")

  | translateExpr (Ast.EVar  x )		   = let 
  											val _ = case SymTable.checkkey(Atom.atom x) of true => () | false => (raise undef)
  										 in(x)end	

  | translateExpr (Ast.ARVar  (x,e) )		   = let 
  											val _ = case SymTable.checkkey(Atom.atom x) of true => () | false => (raise undef)
  										 in(x^"["^(translateExpr e)^"]")end
  
  | translateExpr (Ast.Op (x, oper, y))  = ((translateExpr x) ^ (Ast.binOpToString oper) ^ (translateExpr y ))





(**************************************************************************************************************************************)
(**************************************************************************************************************************************)
(***************************************************translate  CONDITION*****************************************************************)
(**************************************************************************************************************************************)
(**************************************************************************************************************************************)



fun translateCondition (Ast.CConst x)	  = (" "^(Int.toString x)^" ")

  | translateCondition (Ast.CVar  x)		  = let
  												val _ = case SymTable.checkkey(Atom.atom x) of true => () | false => (raise undef)
  											in(" "^x^" ")end

  | translateCondition (Ast.CondOp (x,oper,y)) = ((translateCondition x) ^ (Ast.condOpToString oper) ^ (translateCondition y))




(**************************************************************************************************************************************)
(**************************************************************************************************************************************)
(*****************************************translate STATEMENT AND STATEMENTS*************************************************************)
(**************************************************************************************************************************************)
(**************************************************************************************************************************************)


fun    translateStatement (Ast.As (x,exp,_))	t  		=
	let 
		val ret = (  
			case (SymTable.checkkey(Atom.atom x)) of
			true => ( (addtabs t) ^  (x^" = ") ^ (translateExpr exp) ^ (";\n") )
			|false => ( (addtabs t) ^  ("int "^x^" = ") ^ (translateExpr exp) ^ (";\n") ) 
			)
	in
		SymTable.addkey(Atom.atom x,0);ret
	end


	| translateStatement (Ast.Ret exp)         t  = ( (addtabs t) ^ "return" ^(translateExpr exp)^ ";\n" )



	| translateStatement (Ast.FnCl x)		t  		=  ( (addtabs t) ^  (x^"();\n")  )
	| translateStatement (Ast.If (c,sl))		  t =	(
														(addtabs t) ^ ("if(") ^ (translateCondition c) ^  ("){\n") ^
														(translateStatements (t+1,sl) ) ^
														(addtabs t) ^ ("}\n")
													)	
	| translateStatement (Ast.IfEl (c,sl1,sl2)) t =	(
														(addtabs t) ^  ("if(") ^ (translateCondition c) ^  ("){\n") ^

														(translateStatements (t+1,sl1)) ^

														(addtabs t) ^ ("}\n") ^

														(addtabs t) ^  ("else{\n") ^

														(translateStatements (t+1,sl2) )^

														(addtabs t )^ ("}\n")
													)



and  translateStatements  (t,(x :: xs))	  = ((translateStatement x t)^(translateStatements (t,xs)))
	|translateStatements  (t,[])	   		  = ("")




(**************************************************************************************************************************************)
(**************************************************************************************************************************************)
(************************************************translate FUNCTION**********************************************************************)
(**************************************************************************************************************************************)
(**************************************************************************************************************************************)

fun translateFun(Ast.Fun (x,g))		t  =  let
											val final = Compiler.compileFunction (Ast.Fun(x,g))
											in
												(
											("fun "^x^"(){\n")^
											(translateStatements  (t+1,g) )^
											 ("}\n")
											 
											 )
											end





(**************************************************************************************************************************************)
(**************************************************************************************************************************************)
(***************************************************translate PROGRAM ELEMENT************************************************************)
(**************************************************************************************************************************************)
(**************************************************************************************************************************************)

fun   translateElem (Ast.St statement)	  = translateStatement statement 0	
	| translateElem (Ast.Fn function)       = (translateFun  function 0) 





(**************************************************************************************************************************************)
(**************************************************************************************************************************************)
(**************************************************translate*****************************************************************************)
(**************************************************************************************************************************************)
(**************************************************************************************************************************************)

fun translate []        = ("")
  | translate (x :: xs) = ((translateElem x)^(translate xs))

end
